#!/bin/bash
#
# all the documentation is on the github:
# https://github.com/briner/tsm2deb
# in the README

if [[ $(uname -m) != 'x86_64' ]] ; then
    echo "this script only works for amd64 distribution"
    exit 1
fi


define_variable()
{
    # TSM_ROOT defines the path where the rpms are. tsm4ubuntu will work
    # in this directory
    TSM_ROOT=~/packaging/tsm/7.1.3

    # the name of the package will be
    # <short_org>-<TSM_NAME>-{ba,api..}_<TSM_VER>-<DEB_VER>_amd64
    # so for the current case: unige-tsm-ba_6.3.0-2_amd64.deb
    TSM_NAME=TSM ; # usually it is "TSM"
    TSM_CONF_DIR="/etc/adsm"
    TSM_VER=7.1.3
    SHORT_ORG=UniGE ; # a short name of your organisation

    # where the tsm files will be installed without the first and the last "/"
    OPT_PATH='opt/uau/tsm' ; # usually it is "opt/tivoli/tsm"

    # email of the packager of these
    EMAIL_MAINTAINER='Cedric BRINER <Cedric.Briner@UniGE.ch>'

    #
    # this variable define the name of the rpm for each element
    # this are the file under ls ${TSM_ROOT} once you untar
    # the file dowloaded 6.4.1.0-TIV-TSMBAC-LinuxX86.tar
    unset drpm
    declare -Ag drpm
    drpm["crypt"]="gskcrypt64-8.0.50.44.linux.x86_64.rpm"
    drpm["ssl"]="gskssl64-8.0.50.44.linux.x86_64.rpm"
    drpm["api"]="TIVsm-API64.x86_64.rpm"
    drpm["ba"]="TIVsm-BA.x86_64.rpm"
    #~ drpm["jbb"]="TIVsm-JBB.x86_64.rpm"

    #
    # this variable define of the version of packaging for each element
    # you should be "0" for your first time.
    unset ddeb_ver
    declare -Ag ddeb_ver
    ddeb_ver["crypt"]="0"
    ddeb_ver["ssl"]="0"
    ddeb_ver["api"]="0"
    ddeb_ver["ba"]="0"
    #~ ddeb_ver["jbb"]="0"
    ddeb_ver["integration-cli"]="0" ; # this is only used at the University of Geneva
    ddeb_ver["integration-gtk"]="0" ; # this is only used at the University of Geneva
    ddeb_ver["all"]="0" ; # this is only used for the option -1
}

rpm2dir()
{
    define_variable
    for rpm in ${drpm[*]} ; do
        cd ${TSM_ROOT}
	    d=cpio_${rpm%.rpm}
        [ -d $d ] && rm -fr $d
        echo "extracting $rpm in $d"
        mkdir $d
        cd $d
        rpm2cpio ../${rpm} | cpio -idm
    done
}


#~ ###########################################################
#~ # jbb journal-based-backup
#~ #
#~ wrap_jbb()
#~ {
    #~ OBJ=jbb
#~
    #~ # constructed variable
    #~ define_variable
    #~ DEB_VER=${ddeb_ver[${OBJ}]}
    #~ DEBNAME=${SHORT_ORG,,}-${TSM_NAME,,}-${OBJ}
    #~ DEB_BUILD=${TSM_ROOT}/${DEBNAME}_${TSM_VER}-${DEB_VER}
#~
    #~ cd ${TSM_ROOT}
#~
    #~ [ -d ${DEB_BUILD} ] && rm -fr ${DEB_BUILD}
    #~ mkdir -p ${DEB_BUILD}/{DEBIAN,${OPT_PATH},usr/bin,etc/init.d}
    #~ mkdir -p ${DEB_BUILD}/{var/log/tsm,var/cache/tsmjbb,etc/tsm}
    #~ rsync -aHl cpio_${drpm[${OBJ}]%.rpm}/opt/tivoli/tsm/ ${DEB_BUILD}/${OPT_PATH}/
    #~ rsync -aHl cpio_${drpm[${OBJ}]%.rpm}/etc ${DEB_BUILD}/${OPT_PATH}/etc
    #~ #
    #~ rsync -aHl --force --delete cpio_${drpm[${OBJ}]%.rpm}/usr/lib64/ ${DEB_BUILD}/${OPT_PATH}/lib/
    #~ # relink to the good position the library
    #~ cd ${DEB_BUILD}/${OPT_PATH}/lib/
    #~ for map in $(ls -l * | \
                 #~ sed "s|[[:blank:]]\{2\}| |g" | \
                 #~ cut -d ' ' -f9- | \
                 #~ sed "s| -> |<==>| ;  s|/../opt/tivoli/tsm/|/|" ) ; do
       #~ target=$(echo $map | sed 's|.*<==>||')
       #~ link_name=$(echo $map | sed 's|<==>.*||')
       #~ ln -sf ${target} ${link_name}
    #~ done
    #~ cd - > /dev/null
    #~ #
    #~ # LINK THE EXECUTABLE TO THE WRAPPER (the wrapper is included in the BA)
    #~ cd ${DEB_BUILD}/usr/bin
    #~ for f in tsmjbbd; do
        #~ ln -sf /${OPT_PATH}/bin/tsm-wrapper ${f}; done
    #~ cd ${TSM_ROOT}
    #~ #
    #~ # config file
    #~ cat > ${DEB_BUILD}/etc/tsm/tsmjbbd.ini << EOF
#~ ; This file is the default one created for ${SHORT_ORG} by ${EMAIL_MAINTAINER}.
#~ ; The sample one provided by IBM is on /${OPT_PATH}/client/ba/bin/tsmjbbd.ini.smp
#~ ; and contain the description for all settings
#~
#~ [JournalSettings]
#~ Errorlog=/var/log/tsm/tsmjbb_error.log
#~ Journaldir=/var/cache/tsmjbb
#~
#~
#~ [JournalExcludeList]
#~ ;   Note that this list contains the journal database files.
#~ *.jdb.jbbdb
#~ *.jdbInc.jbbdb
#~
#~
#~ [JournaledFileSystemSettings]
#~ JournaledFileSystems=/home
#~
#~ EOF
    #~ #
    #~ #
    #~ #
    #~ # DEBIAN control
    #~ cat > ${DEB_BUILD}/DEBIAN/control << EOF
#~ Package: ${DEBNAME}
#~ Version: ${TSM_VER}-${DEB_VER}
#~ Architecture: amd64
#~ Maintainer: ${EMAIL_MAINTAINER}
#~ Section: main
#~ Priority: extra
#~ Description: jbb for ${TSM_NAME} @ ${SHORT_ORG}
    #~ Journal Based Backup for ${TSM_NAME}
    #~ TSM stands for Tivoli Storage Manager and it is a solution for backuping is
    #~ machine at ${SHORT_ORG}.
#~ EOF
    #~ #
    #~ #
    #~ #
    #~ # INIT SCRIPT
    #~ cat > ${DEB_BUILD}/etc/init.d/tsmjbbd << 'EOF'
#~ #!/bin/bash
#~ ### BEGIN INIT INFO
#~ # Provides: tsmjbbd
#~ # Required-Start: $local_fs filepath
#~ # Required-Stop: $local_fs filepath
#~ # Default-Start: 3 5
#~ # Default-Stop: 0 1 2 6
#~ # Short-Description: TSM Journal Based Backup daemon
#~ # Description: Start tsmjbbd to enable Journal Based Backup.
#~ ### END INIT INFO
#~ DAEMON=/usr/bin/tsmjbbd
#~ CONF_FILE=/etc/tsm/tsmjbbd.ini
#~ DIR_LOG=/var/log/tsm
#~ PIDFILE=/var/run/tsmjbbd.pid
#~
#~ . /lib/lsb/init-functions
#~
#~ start_tsmjbbd()
#~ {
    #~ log_begin_msg "Starting TSM scheduler ..."
    #~ start-stop-daemon -Sqb --startas /usr/bin/tsmjbbd --pidfile ${PIDFILE} --make-pidfile -- -f  /etc/tsm/tsmjbbd.ini || log_end_msg 1
    #~ log_end_msg 0
#~ }
#~ stop_tsmjbbd()
#~ {
    #~ log_begin_msg "Stopping TSM scheduler ..."
    #~ start-stop-daemon -Kqop ${PIDFILE} || log_end_msg 1
    #~ log_end_msg 0
#~ }
#~
#~ case "$1" in
  #~ start)
    #~ start_tsmjbbd
    #~ ;;
  #~ stop)
    #~ stop_tsmjbbd
    #~ ;;
  #~ restart)
    #~ stop_tsmjbbd
    #~ start_tsmjbbd
    #~ ;;
  #~ *)
    #~ log_success_msg "Usage: /etc/init.d/tsm {start|stop|restart}"
    #~ exit 1
#~ esac
#~
#~ exit 0
#~ EOF
    #~ #
    #~ chmod a+x  ${DEB_BUILD}/etc/init.d/tsmjbbd
    #~ #
    #~ #
    #~ # construct the package
    #~ fakeroot dpkg -b ${DEB_BUILD}
#~ }


###########################################################
# gskcrypt64
#
wrap_crypt()
{
    OBJ=crypt

    # constructed variable
    define_variable
    DEB_VER=${ddeb_ver[${OBJ}]}
    DEBNAME=${SHORT_ORG,,}-${TSM_NAME,,}-${OBJ}
    DEB_BUILD=${TSM_ROOT}/${DEBNAME}_${TSM_VER}-${DEB_VER}_amd64

    cd ${TSM_ROOT}

    [ -d ${DEB_BUILD} ] && rm -fr ${DEB_BUILD}
    mkdir -p ${DEB_BUILD}/{DEBIAN,${OPT_PATH}/gsk8_64}
    rsync -aHl cpio_${drpm[${OBJ}]%.rpm}/usr/local/ibm/gsk8_64/ ${DEB_BUILD}/${OPT_PATH}/gsk8_64/
    #
    #
    # DEBIAN control
    cat > ${DEB_BUILD}/DEBIAN/control << EOF
Package: ${DEBNAME}
Version: ${TSM_VER}-${DEB_VER}
Architecture: amd64
Maintainer: ${EMAIL_MAINTAINER}
Section: main
Priority: extra
Description: gskcrypt64 for ${TSM_NAME} @ ${SHORT_ORG}
    Crypto Library for ${TSM_NAME}
    TSM stands for Tivoli Storage Manager and it is a solution for backuping is
    machine at ${SHORT_ORG}.
EOF
    #
    #
    # construct the package
    fakeroot dpkg -b ${DEB_BUILD}
}



###########################################################
# gskssl64
#
wrap_ssl()
{
    OBJ=ssl

    # constructed variable
    define_variable
    DEB_VER=${ddeb_ver[${OBJ}]}
    DEBNAME=${SHORT_ORG,,}-${TSM_NAME,,}-${OBJ}
    DEB_BUILD=${TSM_ROOT}/${DEBNAME}_${TSM_VER}-${DEB_VER}_amd64

    cd ${TSM_ROOT}

    [ -d ${DEB_BUILD} ] && rm -fr ${DEB_BUILD}
    mkdir -p ${DEB_BUILD}/{DEBIAN,${OPT_PATH}/gsk8_64}
    rsync -aHl cpio_${drpm[${OBJ}]%.rpm}/usr/local/ibm/gsk8_64/ ${DEB_BUILD}/${OPT_PATH}/gsk8_64/
    #
    #
    # DEBIAN control
    cat > ${DEB_BUILD}/DEBIAN/control << EOF
Package: ${DEBNAME}
Version: ${TSM_VER}-${DEB_VER}
Architecture: amd64
Maintainer: ${EMAIL_MAINTAINER}
Section: main
Priority: extra
Description: gskssl64 for ${TSM_NAME} @ ${SHORT_ORG}
 SSL Library for ${TSM_NAME}
 TSM stands for Tivoli Storage Manager and it is a solution for backuping is
 machine at ${SHORT_ORG}.
EOF
    #
    #
    # construct the package
    fakeroot dpkg -b ${DEB_BUILD}
}



###########################################################
# API
#
wrap_api()
{
    OBJ=api

    # constructed variable
    define_variable
    DEB_VER=${ddeb_ver[${OBJ}]}
    DEBNAME=${SHORT_ORG,,}-${TSM_NAME,,}-${OBJ}
    DEB_BUILD=${TSM_ROOT}/${DEBNAME}_${TSM_VER}-${DEB_VER}_amd64

    cd ${TSM_ROOT}

    [ -d ${DEB_BUILD} ] && rm -fr ${DEB_BUILD}
    mkdir -p ${DEB_BUILD}/{DEBIAN,${OPT_PATH}/client}
    rsync -aHl cpio_${drpm[${OBJ}]%.rpm}/opt/tivoli/tsm/client/ ${DEB_BUILD}/${OPT_PATH}/client/
    #
    rsync -aHl --force --delete cpio_${drpm[${OBJ}]%.rpm}/usr/lib64/ ${DEB_BUILD}/${OPT_PATH}/lib/
    cd ${DEB_BUILD}/${OPT_PATH}/lib/
    # relink to the good position the library
    for map in $(ls -l * | \
                 sed "s|[[:blank:]]\{2\}| |g" | \
                 cut -d ' ' -f9- | \
                 sed "s| -> |<==>| ;  s|/../opt/tivoli/tsm/|/|" ) ; do
       target=$(echo $map | sed 's|.*<==>||')
       link_name=$(echo $map | sed 's|<==>.*||')
       ln -sf ${target} ${link_name}
    done
    cd - > /dev/null
    #
    #
    cat > ${DEB_BUILD}/DEBIAN/control << EOF
Package: ${DEBNAME}
Version: ${TSM_VER}-${DEB_VER}
Architecture: amd64
Maintainer: ${EMAIL_MAINTAINER}
Section: main
Priority: extra
Description: api for ${TSM_NAME} @ ${SHORT_ORG}
 API Library for ${TSM_NAME}
 TSM stands for Tivoli Storage Manager and it is a solution for backuping is
 machine at ${SHORT_ORG}.
EOF
    #
    #
    # construct the package
    fakeroot dpkg -b ${DEB_BUILD}
}



###########################################################
# BA
#
wrap_ba()
{
    OBJ=ba

    # constructed variable
    define_variable
    DEB_VER=${ddeb_ver[${OBJ}]}
    DEBNAME=${SHORT_ORG,,}-${TSM_NAME,,}-${OBJ}
    DEB_BUILD=${TSM_ROOT}/${DEBNAME}_${TSM_VER}-${DEB_VER}_amd64

    cd ${TSM_ROOT}

    [ -d ${DEB_BUILD} ] && rm -fr ${DEB_BUILD}
    mkdir -p ${DEB_BUILD}/{DEBIAN,usr/bin,var/log/tsm,${OPT_PATH}/bin}
    mkdir -p ${DEB_BUILD}/{${TSM_CONF_DIR},etc/systemd/system/}
    mkdir -p ${DEB_BUILD}/{usr/share/pixmaps,usr/share/applications}
    mkdir -p ${DEB_BUILD}/usr/share/doc/${DEBNAME}
    rsync -aHl cpio_${drpm[${OBJ}]%.rpm}/opt/tivoli/tsm/ ${DEB_BUILD}/${OPT_PATH}/
    #
    #
    # push the dsm.opt and dsm.sys in ${TSM_CONF_DIR} with a soft link
    mv ${DEB_BUILD}/${OPT_PATH}/client/ba/bin/dsm.sys.smp ${DEB_BUILD}/${TSM_CONF_DIR}
    mv ${DEB_BUILD}/${OPT_PATH}/client/ba/bin/dsm.opt.smp ${DEB_BUILD}/${TSM_CONF_DIR}
    ln -s ${TSM_CONF_DIR}/dsm.opt ${DEB_BUILD}/${OPT_PATH}/client/ba/bin/dsm.opt
    ln -s ${TSM_CONF_DIR}/dsm.sys ${DEB_BUILD}/${OPT_PATH}/client/ba/bin/dsm.sys
    cat > ${DEB_BUILD}/${OPT_PATH}/client/ba/bin/README_${SHORT_ORG^^} << EOF
the dsm.opt and dsm.sys must reside in /${OPT_PATH}/bin as it is in the rpm delivered by IBM,
for convenience we push them in ${TSM_CONF_DIR} and add a link to it in /${OPT_PATH}/client/ba/bin
so that the configuration appear
EOF
    cp ${DEB_BUILD}/${OPT_PATH}/client/ba/bin/README_${SHORT_ORG^^} ${DEB_BUILD}/${TSM_CONF_DIR}/README_${SHORT_ORG^^}
    #/etc/systemd/system/
    #
    # WRAPPER to easy the install of bin on /usr/bin and to
    # let the agent to use this environment when passinf from user to root
    cat > ${DEB_BUILD}/${OPT_PATH}/bin/tsm-wrapper << EOF
#!/bin/bash
export DSM_DIR=/${OPT_PATH}/client/ba/bin/
export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
export PATH="/usr/lib/jvm/java-8-openjdk-amd64/bin:${PATH}"
export LD_LIBRARY_PATH="/${OPT_PATH}/client/api/bin64:\
/${OPT_PATH}/gsk8/lib/:\
/${OPT_PATH}/lib/:"

appname=\$(basename \$0)
exec \${DSM_DIR}/\${appname} \$@
EOF
    chmod a+x ${DEB_BUILD}/${OPT_PATH}/bin/tsm-wrapper
    #
    #
    # LDCONFIG
    mkdir -p ${DEB_BUILD}/etc/ld.so.conf.d
    cat > ${DEB_BUILD}/etc/ld.so.conf.d/${SHORT_ORG,,}-${TSM_NAME,,}.conf << EOF
/${OPT_PATH}/client/api/bin64
/${OPT_PATH}/gsk8_64/lib64
/${OPT_PATH}/lib
EOF
    #
    #
    # LINK THE EXECUTABLE TO THE WRAPPER
    cd ${DEB_BUILD}/usr/bin
    for f in dsmadmc  dsmagent  dsmc  dsmcad  dsmj  dsmswitch  dsmtca  dsmtrace ; do
        ln -sf /${OPT_PATH}/bin/tsm-wrapper ${f}; done
    cd ${TSM_ROOT}
    #
    #
    # INIT SCRIPT
    cat > ${DEB_BUILD}/etc/systemd/system/tsm.service << 'EOF'
[Unit]
Description=Tivoli Storage Manager client daemon

[Service]
CPUShares=2
Environment="LANG=en_US" "LC_ALL=en_US"
WorkingDirectory=/var/log/tsm
ExecStart=/usr/bin/dsmc schedule

[Install]
WantedBy=multi-user.target
EOF
    #
    #
    # rudimentary doc for unige-ba
    cat > ${DEB_BUILD}/usr/share/doc/${DEBNAME}/README << EOF
- configure dsm.sys and dsm.opt
- inform the tsm manager about your config
- test your config with "dsmc i" until it works
- systemctl enable tsm
- systemctl start tsm
EOF
    #
    #
    # DEBIAN control
    PREFIX=${SHORT_ORG,,}-${TSM_NAME,,}
    DEPENDS="${PREFIX}-crypt, ${PREFIX}-ssl, ${PREFIX}-api"
    RECOMMENDS="default-jre"
    cat > ${DEB_BUILD}/DEBIAN/control << EOF
Package: ${DEBNAME}
Version: ${TSM_VER}-${DEB_VER}
Architecture: amd64
Depends: ${DEPENDS}
Recommends: ${RECOMMENDS}
Maintainer: ${EMAIL_MAINTAINER}
Section: main/home/briner/packaging/tsm/7.1.3//cpio_/opt/tivoli/tsm
Priority: extra
Description: ba for ${TSM_NAME} @ ${SHORT_ORG}
 Backup Agent for ${TSM_NAME}
 TSM stands for Tivoli Storage Manager and it is a solution for backuping is
 machine at ${SHORT_ORG}.
EOF
    #
    #
    # DEBIAN postinst
    cat > ${DEB_BUILD}/DEBIAN/postinst << 'EOF'
#!/bin/sh
set -e

if [ "$1" = "configure" ]; then
	ldconfig
    #
    # check if there is a valid configuration
    if LC_ALL=C dsmc query session > /dev/null 2>&1 ; then
        if LC_ALL=C dsmc query schedule 2>&1 | grep "There are no schedules associated with this node" > /dev/null ; then
            echo " - tsm configuration is good and planning is disabled"
            echo " - if you need a planning, configure it and then"
            echo "   - systemctl enable tsm"
            echo "   - systemctl start tsm"
            systemctl stop tsm 2>&1 >/dev/null
            systemctl disable tsm 2>&1 >/dev/null
            systemctl daemon-reload 2>&1 >/dev/null
        else
            echo " - tsm configuration is good and planning is enabled"
            echo " - enabling the tsm daemon"
            systemctl daemon-reload 2>&1 >/dev/null
            systemctl enable tsm 2>&1 > /dev/null
            systemctl restart tsm || exit $?
        fi
    else
        echo " - tsm is not configured or the configuration is broken"
        echo " - we will not launch the daemon tsm"
        echo " - when tsm will be well configured and the schedule planned, do:"
        echo "   - systemctl daemon-reload"
        echo "   - systemctl enable tsm"
        echo "   - systemctl start tsm"
        systemctl stop tsm.service 2>&1 >/dev/null
        systemctl disable tsm.service 2>&1 > /dev/null
        systemctl daemon-reload 2>&1 > /dev/null
    fi
fi
EOF
    #
    chmod a+x ${DEB_BUILD}/DEBIAN/postinst
    #
    #
    # DEBIAN postrm
    cat > ${DEB_BUILD}/DEBIAN/postrm << EOF
#!/bin/sh
set -e

if [ "$1" = "remove" ]; then
    ldconfig
    systemctl stop tsm >& /dev/null
    systemctl disable tsm >& /dev/null
    systemctl daemon-reload >& /dev/null
fi

EOF
    #
    chmod a+x ${DEB_BUILD}/DEBIAN/postrm
    #
    #
    # DESKTOP dsmj & dsmc
    unzip -p cpio_${drpm[${OBJ}]%.rpm}/opt/tivoli/tsm/client/ba/bin/dsm.jar \
             COM/ibm/storage/adsm/cadmin/clientgui/images/dsmwin32.gif \
         | convert - ${DEB_BUILD}/usr/share/pixmaps/dsmwin32.png
    cat > ${DEB_BUILD}/usr/share/applications/dsmj.desktop  << EOF
[Desktop Entry]
Name=dsmj
Comment=tsm gui
Exec=dsmj
Icon=dsmwin32.png
Terminal=false
Type=Application
Categories=System;
EOF
    cat > ${DEB_BUILD}/usr/share/applications/dsmc.desktop  << EOF
[Desktop Entry]
Name=dsmc
Comment=tsm command line interface
Exec=dsmc
Icon=dsmwin32.png
Terminal=true
Type=Application
Categories=System;
EOF
    #
    #
    # construct package
    fakeroot dpkg -b ${DEB_BUILD}
}



###########################################################
# INTEGRATION
wrap_integration_cli()
{
    OBJ="integration-cli"

    # constructed variable
    define_variable
    DEB_VER=${ddeb_ver[${OBJ}]}
    DEBNAME=${SHORT_ORG,,}-${TSM_NAME,,}-${OBJ}
    DEB_BUILD=${TSM_ROOT}/${DEBNAME}_${TSM_VER}-${DEB_VER}_amd64


    cd ${TSM_ROOT}

    [ -d ${DEB_BUILD} ] && rm -fr ${DEB_BUILD}
    mkdir -p ${DEB_BUILD}/{usr/bin,DEBIAN,${OPT_PATH}/share}

    #
    #
    # TSM CONFIGURE TOOL WRITTEN BY cED
    cp ~/packaging/tsm/tsm-configure ${DEB_BUILD}/usr/bin/tsm-configure
    chmod a+x ${DEB_BUILD}/usr/bin/tsm-configure
    cd ${TSM_ROOT}

    #
    # tsm template for server
    cat > ${DEB_BUILD}/${OPT_PATH}/share/template_dsm.sys_server << eof
SERVERNAME tc_servername
    NODENAME          tc_nodename
    TCPSERVERADDRESS  tc_serveradress
    TCPPORT           tc_port
    PASSWORDACCESS    generate
    SCHEDLOGRETENTION 7 D
eof
    #
    # tsm template for desktop
cat > ${DEB_BUILD}/${OPT_PATH}/share/template_dsm.sys_desktop<< eof
SERVERNAME tc_servername
NODENAME          tc_nodename
TCPSERVERADDRESS  tc_serveradress
TCPPORT           tc_port
PASSWORDACCESS    generate
PRENSCHEDULECMD   /opt/uau/tsm/bin/notify-send-tsm.start
POSTNSCHEDULECMD  /opt/uau/tsm/bin/notify-send-tsm.stop
SCHEDLOGRETENTION 7 D
eof
    #
    #
    # DEBIAN control
    cat > ${DEB_BUILD}/DEBIAN/control << EOF
Package: ${DEBNAME}
Version: ${TSM_VER}-${DEB_VER}
Architecture: amd64
Depends: wget, ${SHORT_ORG,,}-${TSM_NAME,,}-ba
Maintainer: ${EMAIL_MAINTAINER}
Section: main
Priority: extra
Description: integration in command line for TSM @ ${SHORT_ORG}
 Integration for TSM
 TSM stands for Tivoli Storage Manager and it is a solution for backuping is
 machine at ${SHORT_ORG}.
EOF
    #
    #
    # construct the package
    fakeroot dpkg -b ${DEB_BUILD}
}

wrap_integration_gtk()
{
    OBJ="integration-gtk"

    # constructed variable
    define_variable
    DEB_VER=${ddeb_ver[${OBJ}]}
    DEBNAME=${SHORT_ORG,,}-${TSM_NAME,,}-${OBJ}
    DEB_BUILD=${TSM_ROOT}/${DEBNAME}_${TSM_VER}-${DEB_VER}_amd64


    cd ${TSM_ROOT}

    [ -d ${DEB_BUILD} ] && rm -fr ${DEB_BUILD}
    mkdir -p ${DEB_BUILD}/{usr/share/pixmaps,usr/share/applications}
    mkdir -p ${DEB_BUILD}/{${TSM_CONF_DIR},usr/bin,DEBIAN,${OPT_PATH}/bin,${OPT_PATH}/share}

    #
    #
    # GUI NOTIFICATION start
    wget -q -O ${DEB_BUILD}/usr/share/pixmaps/tsm-unige.png http://ubuntu.unige.ch/img/icon/ubuntu-at-unige.png
    cat > ${DEB_BUILD}/${OPT_PATH}/bin/notify-send-tsm.start  << EOF
#!/bin/bash
# 60000 ms= 1min
notify-send -i /usr/share/pixmaps/tsm-unige.png --expire-time=60000 "Sauvegarde Start" \\
  "Lancement de la sauvegarde de votre machine par TSM sur les serveurs de l'UniGE."
EOF
    #
    chmod a+x ${DEB_BUILD}/${OPT_PATH}/bin/notify-send-tsm.start
    #
    #
    # GUI NOTIFICATION stop
    cat > ${DEB_BUILD}/${OPT_PATH}/bin/notify-send-tsm.stop  << EOF
#!/bin/bash
# 1800000 ms= 30min
notify-send -i /usr/share/pixmaps/tsm-unige.png  --expire-time=1800000 "Sauvegarde Stop" \\
  "La sauvegarde de votre machines par TSM sur les seveurs de l'UniGE a abouti."
EOF
    #
    chmod a+x ${DEB_BUILD}/${OPT_PATH}/bin/notify-send-tsm.stop
    #
    #
    # DESKTOP tsm-configure
    wget -q -O ${DEB_BUILD}/usr/share/pixmaps/tsm-configure.png http://ubuntu.unige.ch/img/icon/tsm-configure.png
    cat > ${DEB_BUILD}/usr/share/applications/tsm-configure.desktop << EOF
[Desktop Entry]
Name=tsm-configure
Comment=Configure TSM the UniGE way
Comment[fr]=Configurer TSM à la sauce UniGE
Exec=gksu tsm-configure gtk
Icon=tsm-configure.png
Terminal=False
Type=Application
Categories=System;unige;
EOF
    #
    #
    # DEBIAN control
    cat > ${DEB_BUILD}/DEBIAN/control << EOF
Package: ${DEBNAME}
Version: ${TSM_VER}-${DEB_VER}
Architecture: amd64
Depends: libnotify-bin, zenity, gksu, ${SHORT_ORG,,}-${TSM_NAME,,}-ba, ${SHORT_ORG,,}-${TSM_NAME,,}-integration-cli
Maintainer: ${EMAIL_MAINTAINER}
Section: main
Priority: extra
Description: integration for TSM @ ${SHORT_ORG}
 Integration for TSM
 TSM stands for Tivoli Storage Manager and it is a solution for backuping is
 machine at ${SHORT_ORG}.
EOF
    #
    #
    # construct the package
    fakeroot dpkg -b ${DEB_BUILD}
}



###########################################################
# ALL IN ONE
#
all_in_one()
{
    define_variable
    OBJ=all

    # constructed variable
    define_variable
    DEB_VER=${ddeb_ver[${OBJ}]}
    DEBNAME=${SHORT_ORG,,}-${TSM_NAME,,}-${OBJ}
    DEB_BUILD=${TSM_ROOT}/${DEBNAME}_${TSM_VER}-${DEB_VER}_amd64
    #
    #
    cd ${TSM_ROOT}

    [ -d ${DEB_BUILD} ] && rm -fr ${DEB_BUILD}
    mkdir -p ${DEB_BUILD}/DEBIAN
    #
    #
    if test "${IS_WRAP_UNIGE}" = "True"
    then
        DEB_TO_INCLUDE="$(echo ${!ddeb_ver[@]} | sed 's|all||')"
    else
        DEB_TO_INCLUDE="$(echo ${!ddeb_ver[@]} | sed 's|all||' | sed 's|integration||')"
    fi

    #
    #
    echo "rsync data of on ${OBJ}"
    for SUB_OBJ in ${DEB_TO_INCLUDE}
    do
        echo "- ${SUB_OBJ}"
        SUB_DEB_VER=${ddeb_ver[${SUB_OBJ}]}
        SUB_DEBNAME=${SHORT_ORG,,}-${TSM_NAME,,}-${SUB_OBJ}
        SUB_DEB_BUILD=${TSM_ROOT}/${SUB_DEBNAME}_${TSM_VER}-${SUB_DEB_VER}_amd64
        #
        # rsync
        echo -n "  - data… "
        cmd="rsync -aHl --exclude=DEBIAN ${SUB_DEB_BUILD}/ ${DEB_BUILD}/"
        if eval $cmd &> /dev/null
        then
            echo "✔"
        else
            echo "✘"
        fi
        #
        # postinst & postrm
        echo -n "  - postinst… "
        if test -f ${SUB_DEB_BUILD}/DEBIAN/postinst
        then
            echo "✔"
            echo "" >> ${DEB_BUILD}/DEBIAN/postinst
            echo "###############" >> ${DEB_BUILD}/DEBIAN/postinst
            echo "# ${SUB_OBJ}"    >> ${DEB_BUILD}/DEBIAN/postinst
            echo "###############" >> ${DEB_BUILD}/DEBIAN/postinst
            sed -n '2,$p' ${SUB_DEB_BUILD}/DEBIAN/postinst >> ${DEB_BUILD}/DEBIAN/postinst
        else
            echo "✘"
        fi
        echo -n "  - postrm… "
        if test -f ${SUB_DEB_BUILD}/DEBIAN/postrm
        then
            echo "✔"
            echo "" >> ${DEB_BUILD}/DEBIAN/postrm
            echo "###############" >> ${DEB_BUILD}/DEBIAN/postrm
            echo "# ${SUB_OBJ}"    >> ${DEB_BUILD}/DEBIAN/postrm
            echo "###############" >> ${DEB_BUILD}/DEBIAN/postrm
            sed -n '2,$p' ${SUB_DEB_BUILD}/DEBIAN/postrm >> ${DEB_BUILD}/DEBIAN/postrm
        else
            echo "✘"
        fi
    done | sed -u "s|^|  |"
    if test -f ${DEB_BUILD}/DEBIAN/postrm
    then
        sed -i '1i#!/bin/bash' ${DEB_BUILD}/DEBIAN/postrm
        chmod a+x ${DEB_BUILD}/DEBIAN/postrm
    fi
    if test -f ${DEB_BUILD}/DEBIAN/postrm
    then
        sed -i '1i#!/bin/bash' ${DEB_BUILD}/DEBIAN/postinst
        chmod a+x ${DEB_BUILD}/DEBIAN/postinst
    fi
    #
    # control
    DEPENDS=$(for SUB_OBJ in ${DEB_TO_INCLUDE}
            do
                SUB_DEB_VER=${ddeb_ver[${SUB_OBJ}]}
                SUB_DEBNAME=${SHORT_ORG,,}-${TSM_NAME,,}-${SUB_OBJ}
                SUB_DEB_BUILD=${TSM_ROOT}/${SUB_DEBNAME}_${TSM_VER}-${SUB_DEB_VER}_amd64
                grep -E "^Depends:" ${SUB_DEB_BUILD}/DEBIAN/control | sed "s|Depends:||"
            done | tr -s " " "\n"  | sed "s|,||" | grep -v "${SHORT_ORG,,}-tsm-" \
                 | sort -u | sed '/^\s*$/d' | tr -s "\n" " " )
    ADEPENDS=($DEPENDS)
    SAVE_IFS=$IFS
    IFS=","
    DEPENDSJOIN="${ADEPENDS[*]}"
    IFS=$SAVE_IFS
    DEBIAN_DEPENDS=$(echo $DEPENDSJOIN | sed -s "s|,|, |")
    cat > ${DEB_BUILD}/DEBIAN/control << EOF
Package: ${DEBNAME}
Version: ${TSM_VER}-${DEB_VER}
Architecture: amd64
Depends: ${DEBIAN_DEPENDS}
Maintainer: ${EMAIL_MAINTAINER}
Section: main
Priority: extra
Description: all in one for TSM @ ${SHORT_ORG}
 This includes all the package in one (ssl, crypt, ba, api, jbb...)
EOF
    #
    #
    # construct the package
    fakeroot dpkg -b ${DEB_BUILD}
}


###########################################################
# last output
#
last_output()
{
define_variable
echo "do fo eg: sudo dpkg  -i ${TSM_ROOT}/*deb"
}

###########################################################
# main
#

usage () {
	scriptname=$(basename ${0})
   cat <<EOF
Usage: $scriptname -esabc1
       usually we do:
         - to do a package per rpm
           $scriptname -esabc
         - to do a package where everything is into one
           $scriptname -esabc1
         - to do a package per rpm @ UNIGE
           $scriptname -esabcu
         - to do a package where everything is into one @ UNIGE
           $scriptname -esabcu1
   -h   displays basic help
   -v   verbose
   -l   stdout and stderr to \$LOG_PATH(${LOG_PATH})
   -e   extract the RPMs in directories
   -s   wrapp ssl
   -a   wrapp api
   -b   wrapp ba
   -c   wrapp crypt
   -1   wrapp then all in one
   -u   wrap unige
EOF
   exit 0
}

IS_EXTRACT="False"
IS_WRAP_SSL="False"
IS_WRAP_API="False"
IS_WRAP_BA="False"
IS_WRAP_CRYPT="False"
IS_WRAP_SSL="False"
IS_WRAP_UNIGE="False"
IS_WRAP_SOMETHING="False"
IS_WRAP_ALL_IN_ONE="False"
while getopts ":esabcuh1" opt; do
  case $opt in
    e)
      IS_EXTRACT="True"
      ;;
    s)
      IS_WRAP_SSL="True"
      IS_WRAP_SOMETHING="True"
      ;;
    a)
      IS_WRAP_API="True"
      IS_WRAP_SOMETHING="True"
      ;;
    b)
      IS_WRAP_BA="True"
      IS_WRAP_SOMETHING="True"
      ;;
    c)
      IS_WRAP_CRYPT="True"
      IS_WRAP_SOMETHING="True"
      ;;
    s)
      IS_WRAP_SSL="True"
      IS_WRAP_SOMETHING="True"
      ;;
    u)
      IS_WRAP_UNIGE="True"
      IS_WRAP_SOMETHING="True"
      ;;
    1)
      IS_WRAP_SOMETHING="True"
      IS_WRAP_ALL_IN_ONE="True"
      ;;
    h)
      usage
      ;;
  esac
done


shift $((OPTIND-1))

if test "${IS_EXTRACT}" = "True"
then
    echo "extract RPMs 2 directory with cpio"
    echo "----------------------------------"
    cd ${TSM_ROOT}
    rpm2dir | sed -u "s|^|  |"
fi

if test "${IS_WRAP_SOMETHING}" = "True"
then
    echo
    echo "wrapping"
    echo "--------"
fi

if test "${IS_WRAP_SSL}" = "True"
then
    echo
    echo " - wrap ssl"
    echo "   --------"
    wrap_ssl | sed -u "s|^|     |"
fi

if test "${IS_WRAP_CRYPT}" = "True"
then
    echo
    echo " - wrap_crypt"
    echo "   ----------"
    wrap_crypt | sed -u "s|^|     |"
fi

if test "${IS_WRAP_API}" = "True"
then
    echo
    echo " - wrap api"
    echo "   --------"
    wrap_api | sed -u "s|^|     |"
fi

if test "${IS_WRAP_BA}" = "True"
then
    echo
    echo " - wrap ba"
    echo "   -------"
    wrap_ba | sed -u "s|^|     |"
fi

#~ if test "${IS_WRAP_JBB}" = "True"
#~ then
    #~ echo
    #~ echo " - wrap jbb"
    #~ echo "   --------"
    #~ wrap_jbb | sed -u "s|^|     |"
#~ fi

if test "${IS_WRAP_UNIGE}" = "True"
then
    echo
    echo " - unige integration"
    echo "   -----------------"
    wrap_integration_cli | sed -u "s|^|     |"
    wrap_integration_gtk | sed -u "s|^|     |"
fi

if test "${IS_WRAP_ALL_IN_ONE}" = "True"
then
    echo
    echo " - all in one"
    echo "   ----------"
    all_in_one | sed -u "s|^|     |"

fi


echo
echo "check the new package created"
echo "-----------------------------"
last_output | sed -u "s|^|  |"
